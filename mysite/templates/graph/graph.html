<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

<!-- Load d3-cloud -->
<script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3.layout.cloud.js"></script>
<!-- <script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-tag-cloud.min.js"></script> -->

<!-- Load color palettes -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<style type="text/css">
  #container {height:100%; width:100%;font-size: 0;}
  #left, #right {display: inline-block; *display: inline; zoom: 1; vertical-align: top; font-size: 15px;}
  #left {width: 30%;}
  #right {width: 70%; }
</style>

<link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/bmabey/pyLDAvis/files/ldavis.v1.0.0.css">

<!-- <div id="ldavis"></div> -->

<!-- Create a div where the graph will take place -->

<div id="mytitle"> 
  <h1>Welcome to the visualization board!</h1>
</div>
<br>
<label for="my_vis1">Following is the distribution map:</label>
<div id="my_vis1"> </div>
<br><br>
<div id='mytest1'></div>

<p id="map-text">foo bar</p>
<!-- <p id="map-text2">foo bar2</p> -->
<div id="mytest2"> {{ place }} </div>

<br><br>

<form method="get">
  <!-- Create a time selection panel -->
  <label for="startlabel">Start date:</label>
  <input type="date" id="start" name="start-date"
         value= "2016-05-27"
         min="2015-01-01" max="2017-12-31">


  <label for="endlabel">End date:</label>
  <input type="date" id="end" name="end-date"
         value="2016-05-28"
         min="2015-01-01" max="2017-12-31">
  <br>
  <input type="submit" class="btn" value="Reset" name="submitreset">

 <!--  <input type="button" id="myButton" value="Apply change" name="buttonclick" onclick="update_map()"> -->
  <button type="button" id="myButton" onclick="update_cloud()">Apply change</button>
  <br>

</form>

<br><br>

<!-- <div id="lda_source">
  <form>
    <input type="radio" name="stack" value="source_date">Show topics on selected date<br>
    <input type="radio" name="stack" value="source_event" >Show topics on selected event
  </form>
</div>
<br><br>
 -->
<div id="container">
  <!-- background-color: yellow; -->
  <div id="left">
      <label for="selectButton" style=' font-size: 20px'>Weather Glossary</label>
    <br>
    <form method="get">
      <select id="selectButton"></select>
    </form>

  </div>
  <div id="right">
    <div id="my_dataviz1"> Following is the wordcloud:</div>
    <br>
    <div id="my_cloudviz" data-value=""> {{ place2 }} </div>
    <!-- Initialize a select button -->
    <br>
    <p id="word-doc-text">No corresponding document</p>
    <br>
    <!-- <input type="submit" class="btn" value="Show WordCloud" name="wordcloud">
     -->
  </div>
</div>

<div id="ldavis_el896531130886231842704230616"></div>

<br><br><br><br><br><br>
<div id="mydataviz3"> Following is the graph for topics:</div>
<p id="topic-text"></p>
<div id= "topic-div"></div>
<br><br>
<input type="text" id="user-input" value="Your input" autofocus="">
<br>
<button type="button" id="sender" onclick="refresh_input()">Send data</button><br>

<div id='my_dataviz'></div>


<script>

// set the dimensions and margins of the graph
var margin = {top: 30, right: 30, bottom: 30, left: 50},
    width = 500 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;


// // append the svg object to the body of the page
// var svg = d3.select("#my_vis1")
//   .append("svg")
//     .attr("width", width + margin.left + margin.right)
//     .attr("height", height + margin.top + margin.bottom)
// var g = svg.append("g")
//           .attr("transform","translate(" + margin.left + "," + margin.top + ")");

// //test graph --> for map
// g.append("ellipse")
//   .attr("cx",250)
//   .attr("cy",250)
//   .attr("rx",50)
//   .attr("ry",80)
//   .attr("fill", "pink")
//   .attr("opacity", 0.5);

// g.append("text")
//   .attr("x", 140)
//   .attr("y", 150)
//   .attr("stroke", "steelblue")
//   .attr("font-family", "sans-serif")
//   .attr("font-size", "24px")
//   .text("I am a pretty ellipse!");


//================================== Weather Event Dropdown Menu ==============================

// var allTerm = JSON.parse('{{ weather_terms | escapejs }}');
// var mildTerm = JSON.parse('{{ mild | escapejs }}');
// var severeTerm = JSON.parse('{{ severe | escapejs }}');
var event_groups = JSON.parse('{{ event_groups|escapejs }}');

d3.select("#selectButton")
  .selectAll('optgroup')
  .data(event_groups)
  .enter()
  .append('optgroup')
  .attr('label',function(d){return d.key})
  .selectAll('option')
  .data(function(d){return d.value})
  .enter()
  .append('option')
  .text(function(d){return d;})
  .attr('value', function(d) {return d;});



function update_menu(selected_event){
  $.ajax({
    url: '',
    data: {
      'selected_event':selected_event
    },
    dataType: 'json',
    success: function (data) {
      console.log(selected_event);
      // $('#map-text').html(data["response"][0]);

      // var ldavis_data = jQuery.parseJSON(data["response"][1]);//
      var ldavis_data = data["response"];

      console.log(ldavis_data)

      // var topic_text = jQuery.parseJSON(data['topics']);
      var topic_text = data['topics'];
      console.log(topic_text);
      console.log(topic_text[0]);
      console.log(topic_text.length);
      // $('#topic-text').html(topic_text[0][1]);
      var extrem = data['extrem'];
      console.log(extrem);
      display_topics(topic_text,extrem);

      // display_topics();
      // $("#ldavis").data("value", ldavis_data);
      // LDAvis_load_lib();

    }
  });
}

d3.select("#selectButton").on("change", function(d) {
    var selectedOption = d3.select(this).property("value");
    update_menu(selectedOption);
})


function display_topics(data,extrem){

  //clear old vis chart
  d3.selectAll("#topic-div > *").remove();

  // var max_prob = max(data, key=itemgetter('prob'))
  // var min_prob = min(data, key=itemgetter('prob'))

  // console.log(max_prob,min_prob)

  var margin = {top: 80, right: 25, bottom: 30, left: 40},
  width = 450 - margin.left - margin.right,
  height = 450 - margin.top - margin.bottom;

  // append the svg object to the body of the page
  var t_svg = d3.select("#topic-div")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

  //Read the data
  // d3.csv("/Users/zou/Desktop/courses/msc_project/project/CH_tweets/mysite/data/topics.csv", function(data) {

  // Labels of row and columns -> unique identifier of the column called 'group' and 'variable'
  var myGroups = d3.map(data, function(d){return d.group;}).keys()
  var myVars = d3.map(data, function(d){return d.variable;}).keys()

  // Build X scales and axis:
  var x = d3.scaleBand()
    .range([ 0, width ])
    .domain(myGroups)
    .padding(0.05);

  t_svg.append("g")
    .style("font-size", 30)
    .attr("transform", "translate(0,0)")
    .call(d3.axisTop(x).tickSize(0))
    .select(".domain").remove()

  // Build Y scales and axis:
  var y = d3.scaleBand()
   .range([ 0,height])
    .domain(myVars)
    .padding(0.05);
  t_svg.append("g")
    .style("font-size", 15)
    .call(d3.axisLeft(y).tickSize(0))
    .select(".domain").remove()
  var colorbar = ["#FFFFBF", "#5E4FA2", "#66C2A5", "#3288BD", "#ABDDA4", "#E6F598", "#FEE08B", "#FDAE61", "#F46D43", "#D53E4F", "#9E0142"]
  // Build color scale
  var myColor = d3.scaleLog()//d3.scalePow() //d3.scaleLinear()
    // .range(["white", "#69b3a2"])
    .range([colorbar[0],colorbar[1]])
    .domain([extrem[0],extrem[1]])

   // var myColor = d3.scaleSequential()
   //  .interpolator(d3.interpolateInferno)
   //  .domain([extrem[0],extrem[1]])
   // var myColor2 = ["#5E4FA2", "#3288BD", "#66C2A5", "#ABDDA4", "#E6F598", "#FFFFBF", "#FEE08B", "#FDAE61", "#F46D43", "#D53E4F"]

  // create a tooltip
  var tooltip = d3.select("#topic-div")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px")

  // Three function that change the tooltip when user hover / move / leave a cell
  var mouseover = function(d) {
    tooltip
      .style("opacity", 1)
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 1)
  }
  var mousemove = function(d) {
    tooltip
      .html("The exact probability of<br>this term in this topic is: " +d.prob)
      .style("left", (d3.mouse(this)[0]+70) + "px")
      .style("top", (d3.mouse(this)[1]) + "px")
  }
  var mouseleave = function(d) {
    tooltip
      .style("opacity", 0)
    d3.select(this)
      .style("stroke", "none")
      .style("opacity", 0.8)
  }


  // add the squares
  t_svg.selectAll()
    .data(data, function(d) {return d.group+':'+d.variable;})
    .enter()
    .append("rect")
      .attr("x", function(d) { return x(d.group) })
      .attr("y", function(d) { return y(d.variable) })
      .attr("rx", 4)
      .attr("ry", 4)
      .attr("width", x.bandwidth() )
      .attr("height", y.bandwidth() )
      // .style("fill", function(d,i) { return myColor2[i%10]} )
      .style("fill", function(d) { return myColor(d.prob)} )
      .style("stroke-width", 4)
      .style("stroke", "none")
      .style("opacity", 0.8)
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseleave", mouseleave);

    // console.log(x.bandwidth(),y.bandwidth())

  var topicText = t_svg.selectAll()
    .data(data)
    .enter()
    .append('text')
    .text(function(d) { return d.text; })
    // .attr("x", function(d,i) { return x.bandwidth()*(i%10+0.5) })
    // .attr("y", function(d,i) { return y.bandwidth()*(i%4+0.5) })
    .attr("x", function(d) { return x(d.group)+x.bandwidth()/2; })
    .attr("y", function(d) { return y(d.variable)+y.bandwidth()/2; })
    .attr('text-anchor', 'middle')
    // .style("fill", "black").style("stroke-width", 1.5)
    .style("font-size", "14px")


}

// =========================================================================


function update_cloud(){
  var startDate = document.getElementById("start").value;
  var endDate = document.getElementById("end").value;

  // pass dates to views.py to process data; 
  // acquire new data results and generate graphs in template

  // console.log(String(startDate),String(endDate));
  // document.getElementById("mytest2").innerHTML = String(startDate)+' to '+String(endDate);

  $.ajax({
    url: '',
    data: {
      'start':startDate,
      'end':endDate
    },
    dataType: 'json',
    success: function (data) {
      console.log(data);
      $('#map-text').html(data["response"][0]);

      var jsonObject = jQuery.parseJSON(data["response"][1]);//

      jsonObject.forEach(function(d){
        d.event = d.event;
        d.doc_list = d.doc_list;
      }
      );
      console.log(jsonObject);
      console.log(Object.keys(jsonObject[0]));
      console.log(jsonObject[5]["doc_list"].length);

      $("#my_cloudviz").data("value", jsonObject);
      draw_cloud();

    }
  });

};

function draw_cloud(){

  d3.selectAll("#my_cloudviz > *").remove();
  var mywords = $("#my_cloudviz").data("value");


// =====AnyChart-Based WordCloud(Only trial version available)============
  // mywords.forEach(function(d){
  //   d.x = d.event;
  //   d.value = d.doc_list.length;

  //   // for AnyChart
  //   // d.x = d.event;
  //   // d.value = d.doc_list.length;
  // }
  // );
  // var chart = anychart.tagCloud(mywords);

  // // chart.title('wordcloud');
  // chart.angles([0]);
  // // chart.fontSize(20);
  // chart.fontWeight(900);
  // // chart.colorRange(true);
  // chart.colorRange().length('80%');
  // chart.container('my_cloudviz');
  // chart.listen("pointClick",function(e){
  //   var event_name = e.point.get("x");
  //   var documnet_name =  mywords.find(el.doc_list => el.event === event_name);

  // })
  // chart.draw();


// ================D3-Based WordCloud======================
  var cloud_svg = d3.select("#my_cloudviz")
    .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform",
      "translate(" + margin.left + "," + margin.top + ")");

  // Constructs a new cloud layout instance. It run an algorithm to find the position of words that suits your requirements
  // Wordcloud features that are different from one word to the other must be here

  var layout = d3.layout.cloud()
    .size([width, height])
    .words(mywords.map(function(d) { return {text: d.event, size:d.doc_list.length, list:d.doc_list}; }))
    .padding(15)        //space between words
    .rotate(function() { return ~~(Math.random() * 2) * 90; })
    // .rotate(0)
    .font("Impact")
    // .fontSize(20)
    .fontSize(function(d) { return d.size; })      // font size of words
    .text(function(d) { return d.text; })
    .on("end", draw);
  layout.start();

  // This function takes the output of 'layout' above and draw the words
  
  function draw(words) {

    var fill = d3.scaleOrdinal(d3.schemeCategory10);
    cloud_svg
      .append("g")
        .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
        .selectAll("text")
          .data(words)
        .enter().append("text")
          .style("font-size", function(d) { return Math.log(d.size)*3+14; })
          // .style("font-size",20)
          .style("fill", function(d, i) { return fill(i); })//"#69b3a2")
          .attr("text-anchor", "middle")
          .style("font-family", "Impact")
          .attr("transform", function(d) {
            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
          })
          .text(function(d) { return d.text; })
          // .on('mouseover',displayFreq)
          .on('mouseover', function(d,event){

            $('#word-doc-text').html('Corresponding documents are '+d.list+''); 
          })
          .on("mouseout", function(d,event){
            $('#word-doc-text').html('No relevant documents');
          });
  }

}


// function displayFreq(d,i){
//   d3.select(this).style(
//     {stroke: black})

//   cloud_svg.append()
// };





// ================Refresh text input======================


function refresh_input(){
  var input = document.getElementById("user-input").value;
  
  $.ajax({
      url: '',
      data: {
        'inputValue': input
      },
      dataType: 'json',
      success: function (data) {
        console.log(data);
        document.getElementById('p-text').innerHTML = data["response"];

      }
    });
};







// ==========================----------------------------==================

</script>